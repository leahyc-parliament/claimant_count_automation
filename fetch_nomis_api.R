library(httr2)
library(readr)
library(dplyr)
library(lubridate)
library(writexl)
library(purrr)
library(stringr)

# function to fetch data from API.
fetch <- function(base_url, geography) {
  
  query_url <- sprintf(base_url, geography)
  
  response <- request(query_url) |>
    req_perform() |>
    resp_body_string() |>
    read_csv() |> 
    select(Month = DATE_NAME, 
           ConstituencyName = GEOGRAPHY_NAME, 
           ONSConstID = GEOGRAPHY_CODE, 
           ConstituencyLevel = OBS_VALUE)
  
  return(response)
}

# nomis geography codes (constituency, region and country). Spread over two lines due to R single line character limit.
geography_1 <- "721420303,721420310,721420347,721420351,721420362,721420365,721420372,721420375,721420380,721420382,721420385,721420400,721420402,721420432,721420450,721420452,721420482,721420493,721420494,721420499,721420504,721420509,721420510,721420515,721420524,721420528,721420570...721420572,721420577,721420585,721420591,721420610,721420616,721420619,721420622,721420627,721420628,721420631,721420634,721420635,721420651,721420663,721420706,721420707,721420715,721420720,721420722,721420723,721420727,721420728,721420733,721420738,721420742,721420756,721420772,721420794,721420795,721420799,721420804,721420816,721420292,721420294,721420305,721420335,721420340,721420366,721420391,721420405,721420418...721420421,721420454,721420469,721420471,721420479,721420492,721420513,721420514,721420537,721420552...721420554,721420562,721420568,721420569,721420581,721420583,721420588,721420590,721420601,721420617,721420630,721420632,721420633,721420636...721420638,721420683,721420684,721420697,721420702,721420709,721420713,721420714,721420716,721420797,721420299,721420307,721420309,721420311,721420312,721420315,721420348...721420350,721420363,721420379,721420386,721420393,721420395,721420398,721420401,721420412...721420415,721420431,721420433...721420435,721420439,721420447,721420449,721420451,721420455,721420462,721420464,721420483,721420485,721420486,721420490,721420491,721420496,721420497,721420502,721420505,721420516,721420518,721420519,721420526,721420527,721420531,721420532,721420536,721420538,721420557...721420560,721420597,721420640,721420643,721420647,721420656,721420660,721420661,721420671,721420674,721420680,721420729,721420751,721420753,721420760,721420776,721420779,721420782,721420784,721420785,721420789,721420802,721420812,721420327,721420332,721420333,721420399,721420409,721420416,721420437,721420470,721420498,721420511,721420521,721420533,721420594,721420593,721420603...721420605,721420608,721420615,721420623,721420666,721420718,721420744,721420745,721420757,721420783,721420793,721420291,721420296,721420302,721420317,721420328...721420331,721420336...721420339,721420368,721420370,721420371,721420378,721420384,721420389,721420390,721420396,721420404,721420411,721420448,721420468,721420477,721420503,721420512,721420525,721420543,721420544,721420555,721420563...721420567,721420573,721420576,721420578...721420580,721420587,721420598,721420641,721420642,721420648,721420650,721420659,721420669,721420672,721420676,721420681,721420685,721420689,721420717,721420730,721420735,721420736,721420741,721420743,721420754,721420765,721420787,721420790,721420791,721420803,721420806,721420809...721420811,721420815,721420824,721420828,721420921...721420938,721420874...721420881,721420864,721420882,721420865,721420883,721420866,721420884...721420891,721420867,721420892...721420908,721420869,721420909...721420911,721420870,721420912,721420913,721420868,721420871,721420914,721420872,721420915...721420919,721420873,721420920,721420289,721420293,721420295,721420297,721420298,721420304,721420308,721420314,721420316,721420334,721420343,721420355,721420356,721420367,721420377,721420383,721420388,721420392,721420410,721420417,721420423,721420427,721420428,721420436"
geography_2 <- "721420438,721420440...721420442,721420444...721420446,721420453,721420456,721420459...721420461,721420465,721420472,721420475,721420478,721420480,721420484,721420489,721420500,721420501,721420506,721420508,721420520,721420522,721420529,721420530,721420556,721420574,721420575,721420586,721420592,721420595,721420596,721420599,721420600,721420602,721420618,721420629,721420645,721420646,721420657,721420658,721420664,721420665,721420668,721420673,721420675,721420682,721420691,721420700,721420703,721420725,721420726,721420731,721420758,721420759,721420775,721420781,721420796,721420813,721420814,721420817...721420819,721420825,721420826,721420306,721420341,721420342,721420352,721420357...721420361,721420374,721420381,721420387,721420394,721420397,721420443,721420457,721420458,721420463,721420466,721420467,721420473,721420474,721420517,721420582,721420589,721420607,721420611...721420614,721420620,721420625,721420652,721420653,721420655,721420686,721420708,721420710...721420712,721420721,721420724,721420734,721420737,721420755,721420762,721420763,721420766,721420768,721420771,721420774,721420777,721420778,721420780,721420798,721420801,721420807,721420829,721420832...721420863,721420290,721420318...721420326,721420364,721420369,721420376,721420406...721420408,721420429,721420430,721420487,721420507,721420535,721420542,721420561,721420584,721420606,721420621,721420624,721420626,721420639,721420667,721420679,721420699,721420704,721420705,721420719,721420739,721420740,721420746...721420750,721420752,721420761,721420764,721420767,721420769,721420773,721420788,721420792,721420800,721420805,721420820...721420823,721420827,721420300,721420301,721420313,721420344...721420346,721420353,721420354,721420373,721420403,721420422,721420424...721420426,721420476,721420481,721420488,721420495,721420523,721420534,721420539...721420541,721420545...721420551,721420609,721420644,721420649,721420654,721420662,721420670,721420677,721420678,721420687,721420688,721420690,721420692...721420696,721420698,721420701,721420732,721420770,721420786,721420808,721420830,721420831,2092957697,2013265926,2013265924,2013265927,2013265921,2013265922,2013265931,2013265928...2013265930,2013265925,2013265923,2013265932"
geography <- paste(geography_1, geography_2, sep = ",")

# constructing query URLs for 12month time periods. Can only return 25,000 data rows per call.
base_urls <- list(
"0_12_months" = "https://www.nomisweb.co.uk/api/v01/dataset/NM_162_1.data.csv?geography=%s&date=latestMINUS11-latest&gender=0&age=0&measure=1,2&measures=20100",
"12_24_months" = "https://www.nomisweb.co.uk/api/v01/dataset/NM_162_1.data.csv?geography=%s&date=latestMINUS23-latestMINUS12&gender=0&age=0&measure=1,2&measures=20100",
"24_36_months" = "https://www.nomisweb.co.uk/api/v01/dataset/NM_162_1.data.csv?geography=%s&date=latestMINUS36-latestMINUS24&gender=0&age=0&measure=1,2&measures=20100"
)

# fetching data from API
response <- map_dfr(base_urls, fetch, geography = geography)

# defining ONS codes for UK and regions.
# note that nomis uses country codes for Scotland, Northern Ireland and Wales even when considered as regions.
uk_code <- "K02000001"
region_codes <- c("E12000001",
                  "E12000002",
                  "E12000003",
                  "E12000004",
                  "E12000005",
                  "E12000006",
                  "E12000007",
                  "E12000008",
                  "E12000009",
                  "S92000003", 
                  "N92000002",
                  "W92000004")

# extract claimant rates at UK level
uk_rate <- response |> 
  filter(ONSConstID == uk_code) |> 
  rename(UKRate = ConstituencyLevel, 
         CountryName = ConstituencyName, 
         CountryID = ONSConstID) |> 
  filter(UKRate <= 20) |> 
  mutate(UKRate = UKRate / 100)

# extract claimant rates at region level
region_rate <- response |> 
  filter(ONSConstID %in% region_codes) |> 
  rename(RegionRate = ConstituencyLevel,
         RegionNationName = ConstituencyName,
         RegionID = ONSConstID) |> 
  filter(RegionRate <= 20) |> 
  mutate(RegionRate = RegionRate / 100)

# remove claimant rates for UK and regions from dataset
response <- response |> 
  filter(!(ONSConstID %in% c(uk_code, region_codes))) 

# extract claimant rates at constituency level
const_rate <- response |> 
  filter(ConstituencyLevel < 20) |> 
  rename(ConstituencyRate = ConstituencyLevel) |> 
  mutate(ConstituencyRate = ConstituencyRate / 100)

# extract claimant count at constituency level
const_cc <- response |> 
  filter(ConstituencyLevel >= 20) |> 
  select(ONSConstID, ConstituencyLevel, Month)

# joining claimant count and rates at constituency level  
claimant_count <- left_join(const_rate, const_cc, by = c("ONSConstID", "Month")) |> 
  mutate(CountryID = uk_code)
  
# lookup for mapping constituency to region
lookup <- read.csv("constituency_region_country_2023.csv") |>
  select(ONSConstID = new_constituency_code,
         RegionID = region_code) |> 
  # using country codes in place of region codes for Scotland, Northern Ireland and Wales
  mutate(RegionID = replace(RegionID, RegionID == "S99999999", "S92000003")) |> # Scotland
  mutate(RegionID = replace(RegionID, RegionID == "W99999999", "W92000004")) |> # Wales
  mutate(RegionID = replace(RegionID, RegionID == "N99999999", "N92000002")) # Northern Ireland

# joining constituency level data with region and country level data
claimant_count <- left_join(claimant_count, lookup, by = "ONSConstID") |> 
  left_join(uk_rate, by = c("CountryID", "Month")) |> 
  left_join(region_rate, by = c("RegionID", "Month")) |> 
  mutate(RegionNationName = str_replace(RegionNationName, "^East$", "East of England")) |> 
  select(ONSConstID,
         ConstituencyName,
         RegionID,
         RegionNationName,
         CountryID,
         CountryName,
         Month,
         ConstituencyLevel,
         ConstituencyRate,
         RegionRate,
         UKRate)

# exporting data as timestamped excel file.
if (!dir.exists("output_data")) {
  dir.create("output_data")
}
timestamp <- format(Sys.time(), "%Y-%m-%d_%H-%M-%S")
write_xlsx(claimant_count, paste0("output_data/claimant_count_", format(Sys.time(), "%Y-%m-%d_%H-%M-%S"), ".xlsx"))

print("File saved successfully!")


